# 2026-01-19 개발 로그

=== 오전: 실시간 접속자 수 (Real-time Online Users) 기능 구현 ===

1. 기능 개요
   - 앱 상단에 "🟢 현재 N명 접속 중" 배지 표시를 통해 서비스 활성화 느낌(Social Proof) 부여.
   - 사용자 활동을 실시간으로 추적하여 '진성 유저'만 카운팅.

2. 백엔드 아키텍처: 하이브리드 추적 전략 (Hybrid Tracking Strategy)
   - **Active Tracking (능동적 갱신)**:
     - 유저가 API(좋아요, 채팅 등)를 호출할 때마다 `last_active_at` 시간을 자동으로 갱신.
     - `get_current_user` 의존성 주입 함수 내에 갱신 로직을 통합하여 코드 중복 제거.
   - **Passive Tracking (수동적 갱신 - Heartbeat)**:
     - 유저가 아무 활동 없이(눈팅) 화면만 보고 있을 경우를 대비.
     - 프론트엔드에서 주기적으로(1분) `/api/auth/heartbeat` API를 호출하여 생존 신호 전송.
   
3. 데이터베이스 스키마 변경 (Alembic)
   - `user` 테이블에 `last_active_at` (DateTime, Nullable) 컬럼 추가.
   - 마이그레이션 스크립트 생성 및 적용 완료.

4. 프론트엔드 구현
   - `UserStatus.jsx`: 기존 단순 로그인/로그아웃 버튼을 '실시간 상태 배지'로 전면 개편.
   - 30초 주기로 `/api/auth/stats/online` API를 폴링(Polling)하여 접속자 수 갱신.
   - 네온 그린(Green) 컬러와 Pulsing Dot 애니메이션으로 생동감 있는 UI 구현.

=== 오전: 마이페이지(MyPage) UI 고도화 ===

1. 사용자 경험(UX) 개선
   - 기존 상단의 '내 정보' 영역을 '접속자 배지'로 교체하고, 프로필 관리는 하단 탭으로 이동.
   - 인스타그램 등 메이저 앱의 UX 표준(Thumb Zone)을 따름.

2. 데이터 연동
   - `AuthContext`를 통해 로그인 정보를 받아와 닉네임, 이메일 표시.
   - `ui-avatars.com` API를 활용하여 닉네임 기반의 동적 프로필 이미지 생성.
   - 로그인 여부에 따라 '로그인 유도 화면' vs '내 정보 화면' 분기 처리.

3. 로그아웃 기능 추가
   - 마이페이지 내에 로그아웃 버튼을 배치하여 손쉬운 계정 전환 지원.

=== 트러블 슈팅 (Troubleshooting) ===

1. 500 Internal Server Error (SQLAlchemy Interval)
   - 원인: Raw SQL 쿼리 내에서 `NOW() - INTERVAL :minutes` 문법 사용 시 파라미터 바인딩 에러 발생.
   - 해결: Python(`datetime`, `timedelta`)에서 시간을 미리 계산해서 SQL에 파라미터로 넘기는 방식으로 변경하여 DB 의존성 제거 및 안정성 확보.

2. Alembic UndefinedColumnError
   - 원인: PowerShell 터미널에서 `&&` 연산자 사용으로 마이그레이션 명령어가 중간에 끊김 -> DB에 컬럼 생성 안 됨.
   - 해결: `;` 구분자를 사용하여 명령어를 순차적으로 재실행, 스키마 정상 반영.

=== 오후: Youtube 시청 기록 & 데이터베이스 정규화 ===

1. 시청 기록 시스템 설계 (Architecture)
   - 목표: 유저의 취향을 분석하기 위해 유튜브 시청 데이터를 수집.
   - **설계 고민 (Data Normalization)**:
     - Log 테이블에 영상 제목, 썸네일 등을 다 넣으면 데이터 중복 발생 & 일관성 깨짐 우려.
   - **결정**: 정규화(Normalization) 채택.
     - `YoutubeList` 테이블: 영상 메타데이터(제목, 썸네일 등) 저장 (Source of Truth).
     - `UserLog` 테이블: `users_id`, `video_id`, `action`만 저장.
     - 조회 시: `JOIN` 연산을 통해 최신 영상 정보를 결합하여 반환.

2. 시청 로그 저장 로직 (Upsert)
   - `YoutubeList`에 해당 비디오 ID가 없으면 메타데이터 Insert.
   - `UserLog`에 시청 행위(View) Insert.
   - 이를 통해 중복 저장을 막고 스토리지 효율성 극대화.

=== 오후: 실시간 접속자 기능 최적화 (Optimization) ===

1. 문제 상황
   - 로그아웃을 해도 '최근 5분 활동' 기준 때문에 즉시 접속자 수가 줄어들지 않음.

2. 해결책: '타임머신' 전략 (Time Machine Strategy)
   - 로그아웃 버튼 클릭 시, 해당 유저의 `last_active_at` 시간을 **1시간 전(과거)**으로 강제 업데이트.
   - 별도의 `is_online` 컬럼 추가나 쿼리 수정 없이, 기존 '5분 이내' 조회 조건에서 즉시 제외됨.
   - **Effect**: 최소한의 코드 수정으로 리얼타임에 가까운 반응 속도 구현.

=== 배포 시스템 개선 (DevOps) ===

1. 윈도우 원클릭 배포 (One-Click Deploy)
   - 매번 SSH 접속 후 `git pull` 하는 번거로움을 해결하기 위해 `deploy_remote.ps1` 작성.
   - `scripts/` 폴더로 배포 스크립트들을 정리하여 프로젝트 구조 개선.

=== 코딩 컨벤션 (Coding Convention) ===

1. SQL 파라미터 바인딩 규칙 (SQLAlchemy)
   - **규칙**: `?`나 `%s` 같은 위치 기반(Positional) 파라미터 대신, 반드시 **`:name` 기반의 네임드 파라미터(Explicit Named Parameter Binding)**를 사용한다.
   - **데이터 전달**: 파라미터 값은 `execute` 함수의 두 번째 인자로 **딕셔너리(`dict`)** 형태로 명시적으로 전달한다.
   - **이유**:
     - 가독성 향상: SQL문 내의 변수명과 실제 데이터가 1:1로 매칭되어 직관적임.
     - 안전성: 파라미터 순서가 바뀌어도 데이터가 꼬이는 휴먼 에러 방지.
   - **Bad Case**: `execute("INSERT ... VALUES (%s, %s)", (val1, val2))`
   - **Good Case**: 
     ```python
     await execute(
         "INSERT ... VALUES (:id, :name)", 
         {"id": 1, "name": "Test"}
     )
     ```
