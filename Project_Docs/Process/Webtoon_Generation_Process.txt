================================================================================
                        AI 웹툰 생성 프로세스 설계서
================================================================================

작성일: 2026-01-27
목적: LangGraph + Google GenAI를 활용한 자동 웹툰 생성 워크플로우

================================================================================
1. 사용자 입력 (Input Schema)
================================================================================

    1. 인물 갯수 (character_count)
       - 타입: Integer
       - 예시: 2 (남녀 주인공)
    
    2. 인물 설명 (character_descriptions)
       - 타입: String
       - 예시: "남자 주인공: 20대 후반, 키 큰 직장인, 차가운 외모
                여자 주인공: 20대 중반, 밝고 활발한 카페 직원"
    
    3. 컷 갯수 (scene_count)
       - 타입: Integer
       - 예시: 4 (4컷 만화)
    
    4. 글 길이 (script_length)
       - 타입: String (short/medium/long)
       - 예시: "medium" (각 씬당 50-100 단어)
    
    5. 줄거리 내용 (story_topic)
       - 타입: String
       - 예시: "비 오는 날 우연히 만난 두 사람의 첫 만남"

================================================================================
2. GenAI 모델 선택
================================================================================

    텍스트 생성: gemini-2.0-flash-exp (가장 저렴하고 빠름)
    이미지 생성: imagen-3.0-generate-001 (Gemini 이미지 생성 모델)
    
    참고: Google GenAI API 사용 (GOOGLE_API_KEY 환경변수 필요)

================================================================================
3. LangGraph 워크플로우 설계 (6 Nodes)
================================================================================

    [State 구조]
    - user_input: dict (입력 데이터)
    - full_script: str (생성된 전체 스토리)
    - character_visuals: list[dict] (인물별 외형 묘사 + 이미지 경로)
    - scenes: list[dict] (각 씬별 텍스트 + 이미지 경로)
    - novel_id: int (DB 저장된 Novel ID)
    - current_step: str (현재 진행 단계)

    -----------------------------------------------------------------------
    Node 1: ScriptWriter (줄거리 생성)
    -----------------------------------------------------------------------
        입력: user_input (topic, length, character_count, character_descriptions)
        출력: full_script (생성된 전체 스토리)
        
        프롬프트 구조:
            "다음 조건으로 {scene_count}개의 씬으로 구성된 로맨스 웹툰 스토리를 작성하세요.
             - 인물 수: {character_count}명
             - 인물 설명: {character_descriptions}
             - 줄거리: {story_topic}
             - 글 길이: 각 씬당 {script_length} 수준
             
             각 씬은 [Scene N] 형식으로 구분하고, 감정과 행동이 드러나도록 작성하세요."
        
        GenAI Call: gemini-2.0-flash-exp

    -----------------------------------------------------------------------
    Node 2: CharacterDesigner (인물 외형 묘사 생성)
    -----------------------------------------------------------------------
        입력: full_script, character_descriptions
        출력: character_visuals (각 인물별 상세한 비주얼 묘사)
        
        프롬프트 구조:
            "다음 스토리의 등장인물들의 외형을 이미지 생성에 적합하도록 구체적으로 묘사하세요.
             스토리: {full_script}
             기본 설명: {character_descriptions}
             
             각 인물마다 다음을 포함하세요:
             - 이름/별칭
             - 나이, 성별
             - 헤어스타일, 눈 색깔, 체형
             - 의상 스타일
             - 분위기/느낌
             
             JSON 형식으로 반환: [{name: '...', description: '...'}]"
        
        GenAI Call: gemini-2.0-flash-exp

    -----------------------------------------------------------------------
    Node 3: CharacterImageGenerator (인물 이미지 생성)
    -----------------------------------------------------------------------
        입력: character_visuals
        출력: character_visuals 업데이트 (image_path 추가)
        
        동작:
            - 각 character_visual에 대해:
              1. 영문 프롬프트 생성 (이미지 생성용)
              2. GenAI 이미지 생성 API 호출
              3. 이미지 저장 (파일명: character_{idx}.png)
              4. 경로를 character_visuals에 추가
        
        GenAI Call: imagen-3.0-generate-001

    -----------------------------------------------------------------------
    Node 4: SceneSplitter (씬별 분할)
    -----------------------------------------------------------------------
        입력: full_script, scene_count
        출력: scenes (각 씬별 텍스트)
        
        동작:
            - full_script에서 [Scene N] 태그 기준으로 파싱
            - 각 씬에 순서 번호 부여
            - scenes = [{order: 1, text: '...'}, ...]
        
        GenAI 미사용 (단순 텍스트 파싱)

    -----------------------------------------------------------------------
    Node 5: SceneImageGenerator (씬별 이미지 생성)
    -----------------------------------------------------------------------
        입력: scenes, character_visuals
        출력: scenes 업데이트 (image_path 추가)
        
        동작:
            - 각 scene에 대해:
              1. 프롬프트 생성:
                 "웹툰 스타일 이미지. 
                  등장인물: {character_visuals의 묘사 요약}
                  씬 내용: {scene.text}
                  분위기: 로맨틱, 감성적"
              2. GenAI 이미지 생성 API 호출
              3. 이미지 저장 (파일명: scene_{scene_order}.png)
              4. 경로를 scene에 추가
        
        GenAI Call: imagen-3.0-generate-001

    -----------------------------------------------------------------------
    Node 6: DatabaseWriter (DB 저장)
    -----------------------------------------------------------------------
        입력: full_script, scenes (이미지 경로 포함)
        출력: novel_id
        
        동작:
            1. novels 테이블에 삽입 (title, script)
            2. novel_cuts 테이블에 각 scene 삽입 
               (novel_id, cut_order, scene_desc, image_path)
            3. novel_id 반환

================================================================================
4. API 엔드포인트 수정
================================================================================

    기존: POST /novel/generate
    - 입력: {topic: str}
    - 동작: Mock 데이터 생성
    
    수정 후: POST /novel/generate
    - 입력: {
        topic: str,
        character_count: int,
        character_descriptions: str,
        scene_count: int,
        script_length: str
      }
    - 동작: LangGraph 워크플로우 실행
    - 응답: Novel 객체 (cuts 포함)

================================================================================
5. 프론트엔드 진행 상태 표시
================================================================================

    방법 1: WebSocket (실시간 진행 상황 푸시)
    - 각 Node 완료 시 메시지 전송
    - 예: "줄거리 생성 중...", "인물 1 이미지 생성 중...", "씬 3/4 생성 중..."
    
    방법 2: Polling (REST API)
    - /novel/status/{task_id} 엔드포인트
    - 클라이언트가 주기적으로 상태 조회
    - 응답: {step: "SceneImageGenerator", progress: "3/4"}
    
    권장: 방법 2 (구현 난이도가 낮고 2일 안에 완성 가능)

================================================================================
6. 파일 구조
================================================================================

    back/
      novel/
        langgraph_workflow.py    # LangGraph 워크플로우 정의
        image_service.py         # GenAI 이미지 생성 헬퍼
        router.py                # 수정 (워크플로우 호출)
        service.py               # 기존 유지
      
      static/
        generated/
          characters/            # 인물 이미지
          scenes/                # 씬 이미지
    
    front/
      src/
        pages/Novel/
          NovelCreate.jsx        # 수정 (입력 필드 추가)
          GenerationProgress.jsx # 신규 (진행 상태 UI)

================================================================================
7. 구현 우선순위 (2일 일정)
================================================================================

    Day 1 오전:
      - GenAI 이미지 생성 클라이언트 구현
      - LangGraph 워크플로우 기본 구조 작성 (Node 1-2)
    
    Day 1 오후:
      - Node 3-6 구현
      - Router 통합
    
    Day 2 오전:
      - 프론트엔드 입력 폼 확장
      - 진행 상태 UI 추가
      - 통합 테스트
    
    Day 2 오후:
      - 버그 수정
      - 포트폴리오용 데모 시나리오 작성
      - 아이피아 발표 자료 준비

================================================================================
8. 예상 문제 및 해결 방안
================================================================================

    문제 1: 이미지 생성 속도 느림
    해결: 병렬 처리 (asyncio.gather)
    
    문제 2: 인물 일관성 문제 (매 씬마다 다른 얼굴)
    해결: Character 이미지를 프롬프트에 포함 (IP-Adapter 없이 텍스트로만)
          - "이전에 생성된 인물: {character_visual.description}"
    
    문제 3: GenAI 이미지 API 비용
    해결: 개발 중 Mock 이미지 사용, 데모 시에만 실제 생성
    
    문제 4: LangGraph State 관리 복잡도
    해결: State를 단순하게 유지, 각 Node는 필요한 필드만 업데이트

================================================================================
